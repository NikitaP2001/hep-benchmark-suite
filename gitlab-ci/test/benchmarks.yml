# This template tests the hep-benchmark-suite running a configurable set of benchmarks defined in $benchmark
# 
# !!! Note hs06 & spec17 jobs will silently fail for non-protected branches since protected variables cannot be accessed
# !!! This includes merge request pipelines - https://gitlab.com/gitlab-org/gitlab/-/issues/28002
.test_benchmarks:
  stage: test-benchmarks
  dependencies: []
  retry: 2  # tmp to workaround worker with user namespace issues
  tags:
    - hep-benchmarks  # Requires a machine with 20GB free
    - x86_64          # CC7 image not available for aarch64
  variables:
    bmk_volume: /tmp/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}
    config: tests/ci/benchmarks.yml
  script:
    # Before
    - yum install -y -q gettext moreutils git python3-pip
    - envsubst < $config | sponge $config   # Replace env variables in the config file
    - export PATH=$PATH:$HOME/.local/bin    # $PATH cannot be modified in the variables section
    - python3 -m pip install -U pip wheel
  # Script
    - python3 -m pip install --user .
    - bmkrun --mode=$executor --config=$config --rundir=$bmk_volume --benchmarks=$benchmark
  after_script:
    - mv $bmk_volume/run_*/bmkrun_report.json $CI_PROJECT_DIR
    - rm -rf $bmk_volume
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^qa.*$/ || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^qa.*$/
  artifacts:
    paths:
      - bmkrun_report.json
      - $config
    expire_in: 1 week
    when: always
  parallel:
    matrix:
      - benchmark: [hepscore, hs06, spec2017]

apptainer:
  extends: .test_benchmarks
  image: gitlab-registry.cern.ch/linuxsupport/cc7-base # Use an image that has apptainer.cern repo
  variables:
    SINGULARITY_CACHEDIR: $CI_PROJECT_DIR/apptainer_cachedir
    executor: singularity
  before_script:
    - yum install -y -q apptainer
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    paths:
      - apptainer_cachedir/**/*
  artifacts:
    exclude:
      - apptainer_cachedir

docker:
  extends: .test_benchmarks
  image: gitlab-registry.cern.ch/hep-benchmarks/hep-workloads-builder/dind:v1.0 # Use an image that has docker installed
  variables:
    executor: docker

# Extract commented version of the test without privileges
# Singularity
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    # install the benchmark suite python package & run unprivileged
    #- su unprivUser -c "python3 -m pip install --user ."
    #- su unprivUser -c "bmkrun --mode=singularity --config=tests/ci/benchmarks.yml --rundir=$bmk_volume --benchmarks=$benchmark"
# Docker
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    #- usermod -aG docker unprivUser
    #- su - unprivUser
    #- set -e
