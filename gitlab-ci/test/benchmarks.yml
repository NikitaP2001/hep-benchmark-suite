# This template tests the hep-benchmark-suite running a configurable set of benchmarks defined in $benchmark
# 
# !!! Note hs06 & spec17 jobs will silently fail for non-protected branches since protected variables cannot be accessed
# !!! This includes merge request pipelines - https://gitlab.com/gitlab-org/gitlab/-/issues/28002
.test_benchmarks:
  stage: test-benchmarks
  dependencies: []
  retry: 1  # tmp to workaround worker with user namespace issues
  tags:
    - hep-benchmarks  # Requires a machine with 20GB free
    - x86_64          # CC7 and wl-builder/dind images are only available for x86
  image: gitlab-registry.cern.ch/hep-benchmarks/hep-workloads-builder/dind:v1.0 # Use an image that has docker installed
  variables:
    bmk_volume: /tmp/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}
    config: tests/ci/benchmarks.yml
    SINGULARITY_CACHEDIR: $CI_PROJECT_DIR/apptainer_cachedir
  script:
    # Before
    - ${CI_PROJECT_DIR}/gitlab-ci/test/benchmarks.sh
  after_script:
    - mv $bmk_volume/run_*/bmkrun_report.json $CI_PROJECT_DIR
    - rm -rf $bmk_volume
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^qa.*$/
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^qa.*$/ && $benchmark == "hepscore"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^qa.*$/ && $benchmark == "hepscore"     # to test a branch before merging in qa
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    paths:
      - apptainer_cachedir/**/*
  artifacts:
    paths:
      - bmkrun_report.json
      - $config
    exclude:
      - apptainer_cachedir
    expire_in: 1 week
    when: always

test_hepscore:
  extends: .test_benchmarks
  parallel:
    matrix:
      - executor: [singularity, docker]
        benchmark: [hepscore]
        ncores: [4,8]
        HEPSCORE_VER: [v1.5, v1.6rc4]

test_spec:
  extends: .test_benchmarks
  parallel:
    matrix:
      - executor: [singularity, docker]
        benchmark: [hs06, spec2017]
        ncores: [4,8]

# Extract commented version of the test without privileges
# Singularity
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    # install the benchmark suite python package & run unprivileged
    #- su unprivUser -c "python3 -m pip install --user ."
    #- su unprivUser -c "bmkrun --mode=singularity --config=tests/ci/benchmarks.yml --rundir=$bmk_volume --benchmarks=$benchmark"
# Docker
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    #- usermod -aG docker unprivUser
    #- su - unprivUser
    #- set -e
