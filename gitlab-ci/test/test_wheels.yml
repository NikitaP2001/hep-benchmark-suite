test_wheels:
  stage: test-wheels
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  needs: [build_wheels]
  tags:
    - $ARCH
  retry: 2
  variables:
    WHEELS_PATH: !reference [build_wheels, variables, WHEELS_PATH]
    HEPSCORE_VER: v1.5
    bmk_volume: !reference [.test_benchmarks, variables, bmk_volume]
    suite_config: !reference [.test_benchmarks, variables, suite_config]
    HEPSCORE_CONFIG: !reference [.test_benchmarks, variables, HEPSCORE_CONFIG]
  before_script:
    - !reference [db12_benchmark, before_script]
    - envsubst < $suite_config | sponge $suite_config   # Replace env variables in the config file
  script:
    - python3 -m pip install --user ${WHEELS_PATH}/*.whl
    - bmk_show_metadata
    - bmkrun --mode=singularity --config=$suite_config --rundir=$bmk_volume --benchmarks=hepscore | tee log
    - grep "with return code 0" log
  after_script: !reference [apptainer, after_script]
  artifacts: !reference [apptainer, artifacts]
  rules:
    - !reference [build_wheels, rules]
  parallel: !reference [build_wheels, parallel]
