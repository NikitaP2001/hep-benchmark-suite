test_examples:
  stage: test-examples
  needs: [ test_wheels_rhel8 ]
  tags:
    - hep-benchmarks  # Requires a machine with 20GB free
    - x86_64          # CC7 and wl-builder/dind images are only available for x86
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  variables:
    EXEC_SCRIPT: $CI_PROJECT_DIR/examples/hepscore/run_HEPscore.sh 
    WORKDIR: /tmp/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}
    PYTHON_VERSION: python36
  before_script:
    - !reference [db12_benchmark, before_script]
  script:
    - mkdir -p $WORKDIR
    - cp ${EXEC_SCRIPT} $WORKDIR/test_script.sh
    - envsubst '${SUITE_VERSION}' < $WORKDIR/test_script.sh | sponge $WORKDIR/test_script.sh
    # Let's make the test faster, running hello-world
    - sed -e 's@\(\s*config:\s*\)default@\1$CI_PROJECT_DIR/tests/ci/hepscore.yaml@' examples/hepscore/run_HEPscore.sh | sponge $WORKDIR/test_script.sh
    - chmod u+x $WORKDIR/test_script.sh
    - $WORKDIR/test_script.sh -s dummy -d $WORKDIR | tee log 
    - grep "with return code 0" log
  after_script:
    - tar -czf $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz $WORKDIR/
    - rm -rf $WORKDIR
  rules:
    - if: $CI_COMMIT_TAG =~ $PEP440_VERSION_REGEX
      variables:
        SUITE_VERSION: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^qa.*$/
      variables:
        SUITE_VERSION: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
  artifacts:
      paths:
        - $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz
      expire_in: 1 week
      when: always
