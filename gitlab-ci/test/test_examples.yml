test_examples:
  stage: test-examples
  needs: [ build_wheels_rhel8 ]
  tags:
    - hep-benchmarks  # Requires a machine with 20GB free
    - x86_64          # CC7 and wl-builder/dind images are only available for x86
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  variables:
    EXEC_SCRIPT: $CI_PROJECT_DIR/examples/hepscore/run_HEPscore.sh 
    WORKDIR: /tmp/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}
    PYTHON_VERSION: python36
  before_script:
    - !reference [db12_benchmark, before_script]
  script:
    - source $CI_PROJECT_DIR/gitlab-ci/test/test_examples.sh; run_script
  after_script:
    - tar -czf $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz $WORKDIR/
    - rm -rf $WORKDIR
  rules:
    - if: $CI_COMMIT_TAG =~ $PEP440_VERSION_REGEX
      variables:
        SUITE_VERSION: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^qa.*$/
      variables:
        SUITE_VERSION: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
  artifacts:
      paths:
        - $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz
      expire_in: 1 week
      when: always
  parallel:
    matrix:
      - sversion: ["", "-v v2.2", "-v qa"]
        splugins: ["", "-b h,l,k,m"]
 