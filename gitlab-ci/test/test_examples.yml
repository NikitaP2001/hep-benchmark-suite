test_examples:
  stage: test-examples
  needs: [ build_wheels ]
  tags:
    - hep-benchmarks  # Requires a machine with 20GB free
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  variables:
    EXEC_SCRIPT: $CI_PROJECT_DIR/examples/hepscore/run_HEPscore.sh 
    WORKDIR: /scratch/tmp/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}
    PYTHON_VERSION: python36
  before_script:
    - !reference [db12_benchmark, before_script]
  script:
    - source $CI_PROJECT_DIR/gitlab-ci/test/test_examples.sh; run_script
  after_script:
    - tar -czf $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz $WORKDIR/
    - rm -rf $WORKDIR
  rules:
    - if: $CI_COMMIT_TAG =~ $PEP440_VERSION_REGEX
      variables:
        SUITE_VERSION: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^qa.*$/
      variables:
        SUITE_VERSION: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
  artifacts:
      paths:
        - $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz
      expire_in: 1 week
      when: always
  parallel:
    matrix:
      # Test default (3.0), v2.2, and QA suite versions with no plugins or a minimal plugin subset (f, l, m)
      - sversion: ["", "-v v2.2", "-v qa"]
        splugins: ["", "-b f,l,m"]

      # Test v2.0 hepscore version with:
      # - default configuration
      # - full plugin set with threadscan enabled (-t)
      - sversion: ["-x v2.0"]
        splugins: ["", "-b f,l,m,s,p -t"]
        
      # Test script with passing flags as a config
      - sversion: [""]
        splugins: [""]
        config_mode: examples/hepscore/config.args