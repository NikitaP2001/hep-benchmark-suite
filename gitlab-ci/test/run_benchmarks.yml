# This template tests the hep-benchmark-suite running a configurable set of benchmarks defined in $benchmark
# 
# !!! Note hs06 & spec17 jobs will silently fail for non-protected branches since protected variables cannot be accessed
# !!! This includes merge request pipelines - https://gitlab.com/gitlab-org/gitlab/-/issues/28002
.test_benchmarks:
  stage: test-benchmarks
  needs: []
  retry: 1  # tmp to workaround worker with user namespace issues
  tags:
    - hep-benchmarks  # Requires a machine with 20GB free
    - x86_64          # CC7 and wl-builder/dind images are only available for x86
  variables:
    bmk_volume: /tmp/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}
    suite_config: tests/ci/benchmarks.yml
    HEPSCORE_CONFIG: tests/ci/hepscore.yaml
  before_script:
    # Install dependencies
    - source $CI_PROJECT_DIR/gitlab-ci/test/run_benchmarks.sh; before_script
  script:
    - source $CI_PROJECT_DIR/gitlab-ci/test/run_benchmarks.sh; run_script
  after_script:
    - tar -czf $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz $bmk_volume/run_*
    - mv $bmk_volume/run_*/bmkrun_report.json $CI_PROJECT_DIR
    - rm -rf $bmk_volume
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^qa.*$/
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^qa.*$/ && $benchmark == "hepscore"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^qa.*$/ && $benchmark == "hepscore"
  artifacts:
    paths:
      - $CI_PROJECT_DIR/${CI_JOB_NAME_SLUG}_${CI_JOB_ID}.tgz
      - bmkrun_report.json
      - $suite_config
      - $HEPSCORE_CONFIG
    expire_in: 1 week
    when: always
  parallel:
    matrix:
      - benchmark: [hs06, spec2017]
        ncores: [4, 8]
      - benchmark: [hepscore]
        ncores: [4, 8]
        hepscore_ver: latest_rc # [BMK-1389] Set it to [latest, latest_rc] once latest > v1.5

apptainer:
  extends: .test_benchmarks
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  variables:
    SINGULARITY_CACHEDIR: $CI_PROJECT_DIR/apptainer_cachedir
    executor: singularity
  before_script:
    - dnf install -y -q epel-release
    - dnf install -y -q apptainer
    - !reference [.test_benchmarks, before_script]
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    paths:
      - apptainer_cachedir/**/*
  artifacts:
    exclude:
      - apptainer_cachedir

docker:
  extends: .test_benchmarks
  needs:
    - job: build_docker_image
      optional: true
  image: gitlab-registry.cern.ch/hep-benchmarks/hep-benchmark-suite/docker:latest # Use an image that has docker installed
  variables:
    executor: docker

# Extract commented version of the test without privileges
# Singularity
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    # install the benchmark suite python package & run unprivileged
    #- su unprivUser -c "python3 -m pip install --user ."
    #- su unprivUser -c "bmkrun --mode=singularity --config=tests/ci/benchmarks.yml --rundir=$bmk_volume --benchmarks=$benchmark"
# Docker
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    #- usermod -aG docker unprivUser
    #- su - unprivUser
    #- set -e
