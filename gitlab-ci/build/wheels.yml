build_wheels:
  stage: deploy
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  retry: 2
  tags:
    - $ARCH
  variables:
    WHEELS_PATH: "suite_wheels_${PYTHON_VERSION}_${ARCH}"
    SSHPASS: !reference [.sshpass, variables, SSHPASS]
  before_script:
    - !reference [.sshpass, before_script]
    - export GLIBC=$(ldd --version | awk 'NR==1 {gsub(/\./,"_",$NF); print $NF}')
    - export PKG_NAME=hep-benchmark-suite-wheels-${ID}-${PYTHON_VERSION/thon}-none-linux_${GLIBC}_${ARCH}.tar
    - dnf install -y epel-release # To install python3.11 and above
    - dnf install -y -q $PYTHON_VERSION --setopt=install_weak_deps=True
    - if [ "${PYTHON_VERSION}" != "python36" ]; then dnf install -y -q ${PYTHON_VERSION}-pip; fi
    - python3 -m pip install --upgrade setuptools wheel pip
  script:
    - python3 -m pip wheel -r requirements.txt --wheel-dir=$WHEELS_PATH .
    - tar -cvf ${PKG_NAME} $WHEELS_PATH
    - export PKG_HASH="$(sha256sum $PKG_NAME) $(date +%Y-%m-%d_%H%M) pipeline-${CI_PIPELINE_ID}"
    - sshpass -e ssh cpubmk@lxplus.cern.ch "[ -d ${FULL_RELEASE_PATH} ] || mkdir -p ${FULL_RELEASE_PATH}"
    - sshpass -e ssh cpubmk@lxplus.cern.ch "echo ${PKG_HASH} >> ${FULL_RELEASE_PATH}/sha256sum.txt"
    - sshpass -e scp -r ${PKG_NAME} cpubmk@lxplus.cern.ch:${FULL_RELEASE_PATH}
  artifacts:
    paths:
      - $WHEELS_PATH
  rules:
    - if: $CI_COMMIT_TAG =~ $PEP440_VERSION_REGEX
      variables:
        ID: $CI_COMMIT_TAG
        FULL_RELEASE_PATH: $CI_EOS_RELEASES/$ID
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      variables:
        ID: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
        FULL_RELEASE_PATH: $CI_EOS_RELEASES/dev/$ID
  parallel:
    matrix:
      - ARCH: [x86_64, aarch64]
        PYTHON_VERSION: [python36, python38, python39, python3.11, python3.12]


delete_dev_wheels:
  stage: deploy
  image: gitlab-registry.cern.ch/linuxsupport/alma8-base
  variables:
    merge_commit: "^Merge branch '(.*)' into .*"
    allowed_branch_names: ^[a-zA-Z0-9_-]+$
    SSHPASS: !reference [.sshpass, variables, SSHPASS]
    DEV_RELEASE_PATH: ${CI_EOS_RELEASES}/dev
  before_script: !reference [.sshpass, before_script]
  script:
    - if [[ $CI_COMMIT_MESSAGE =~ $merge_commit ]]; then branch=${BASH_REMATCH[1]}; fi
    - >
      if [ -n "$branch" ] && [[ $branch =~ $allowed_branch_names ]]; then
        sshpass -e ssh cpubmk@lxplus.cern.ch "rm -rf ${DEV_RELEASE_PATH}/${branch}";
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_MESSAGE =~ /^Merge branch '(.*)' into .*/
